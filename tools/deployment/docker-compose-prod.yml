version: '3.8'

services:
  # Simple nginx web server for now
  web:
    image: nginx:alpine
    container_name: willow-web-prod
    platform: linux/amd64
    restart: unless-stopped
    ports:
      - "80:80"
    depends_on:
      - db
    volumes:
      - ./html:/usr/share/nginx/html:ro
    environment:
      - APP_ENV=${APP_ENV:-production}
      - APP_URL=${APP_URL}
    networks:
      - willow_network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  db:
    image: mariadb:11.4-noble
    container_name: willow-db-prod
    platform: linux/amd64
    user: "${USER_ID:-1000}:${GROUP_ID:-1000}"
    restart: unless-stopped
    environment:
      - MYSQL_DATABASE=${DB_DATABASE}
      - MYSQL_USER=${DB_USERNAME}
      - MYSQL_PASSWORD=${DB_PASSWORD}
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - TZ=America/Chicago
    volumes:
      - db_data:/var/lib/mysql:rw
      - ./backups/db:/docker-entrypoint-initdb.d:ro
    networks:
      - willow_network
    # Database exposed only internally by default
    # ports:
    #   - "3306:3306"
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  redis:
    image: redis:7-alpine
    container_name: willow-redis-prod
    platform: linux/amd64
    user: "${USER_ID:-1000}:${GROUP_ID:-1000}"
    restart: unless-stopped
    volumes:
      - redis_data:/data:rw
    networks:
      - willow_network
    environment:
      - TZ=America/Chicago
    healthcheck:
      test: ["CMD-SHELL", "redis-cli ping || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

  phpmyadmin:
    image: phpmyadmin:latest
    container_name: willow-phpmyadmin-prod
    platform: linux/amd64
    restart: unless-stopped
    ports:
      - "8080:80"
    environment:
      - PMA_HOST=db
      - PMA_PORT=3306
      - PMA_USER=${DB_USERNAME}
      - PMA_PASSWORD=${DB_PASSWORD}
    depends_on:
      - db
    networks:
      - willow_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  db_data:
    driver: local
  
  redis_data:
    driver: local

networks:
  willow_network:
    driver: bridge
    name: willow_production