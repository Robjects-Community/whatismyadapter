# WillowCMS OCI Artifact

This directory contains configuration for building and publishing a WillowCMS OCI (Open Container Initiative) artifact that packages runtime configuration files as a distributable container artifact.

## Overview

The OCI artifact bundles the following configuration components:

- **Nginx Configuration**: Templated server configuration for CakePHP 5.x
- **PHP Configuration**: PHP 8.3 and PHP-FPM configuration files
- **Health Check Scripts**: Container monitoring and log verification utilities
- **SBOM**: Software Bill of Materials (if generated by CI)

## Artifact Contents

```
/artifact/
├── nginx/
│   └── willowcms.conf.tpl         # Nginx configuration template
├── php/
│   ├── php.ini                    # PHP 8.3 configuration
│   └── www.conf                   # PHP-FPM pool configuration
├── healthcheck/
│   ├── healthcheck.sh             # Container health monitoring script
│   └── log_checksum.sh           # Log verification utility
└── sbom.spdx.json                # Software Bill of Materials (optional)
```

## Building the OCI Artifact

### Prerequisites

- Docker with BuildKit support
- Access to a container registry
- Environment variables set in `.env` file

### Build Commands

Build the OCI artifact using the multi-stage Dockerfile:

```bash
# Build the oci-artifact stage
docker buildx build --target oci-artifact -t willowcms-config:latest .

# Build with specific version
docker buildx build --target oci-artifact \
  --build-arg VERSION=1.0.0 \
  --build-arg BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
  --build-arg GIT_COMMIT=$(git rev-parse HEAD) \
  -t willowcms-config:1.0.0 .
```

### Using the Build Script

Use the provided build script for standardized builds:

```bash
# Build development artifact
./tools/oci/build-oci.sh

# Build production artifact with version
VERSION=1.0.0 ./tools/oci/build-oci.sh
```

## Publishing to Registry

### Docker Hub

```bash
# Tag and push
docker tag willowcms-config:latest robjectscommunity/willowcms-config:latest
docker push robjectscommunity/willowcms-config:latest
```

### GitHub Container Registry

```bash
# Login to GitHub Container Registry
echo $GITHUB_TOKEN | docker login ghcr.io -u USERNAME --password-stdin

# Tag and push
docker tag willowcms-config:latest ghcr.io/robjects-community/willowcms-config:latest
docker push ghcr.io/robjects-community/willowcms-config:latest
```

### AWS ECR

```bash
# Login to ECR
aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin 123456789012.dkr.ecr.us-east-1.amazonaws.com

# Tag and push
docker tag willowcms-config:latest 123456789012.dkr.ecr.us-east-1.amazonaws.com/willowcms-config:latest
docker push 123456789012.dkr.ecr.us-east-1.amazonaws.com/willowcms-config:latest
```

## Using the OCI Artifact

### Pulling Configuration Files

Extract configuration files from the artifact:

```bash
# Create temporary container to extract files
docker create --name temp-config willowcms-config:latest
docker cp temp-config:/artifact ./extracted-config
docker rm temp-config
```

### In Kubernetes

Use the artifact as an init container to populate configuration:

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: willowcms
spec:
  initContainers:
  - name: config-loader
    image: willowcms-config:latest
    command: ['cp', '-r', '/artifact', '/config']
    volumeMounts:
    - name: config-volume
      mountPath: /config
  containers:
  - name: willowcms
    image: willowcms:latest
    volumeMounts:
    - name: config-volume
      mountPath: /usr/local/etc
  volumes:
  - name: config-volume
    emptyDir: {}
```

### In Docker Compose

Use volumes from the artifact container:

```yaml
services:
  config:
    image: willowcms-config:latest
    container_name: willowcms-config
    command: ["sleep", "infinity"]
    
  willowcms:
    build: .
    depends_on:
      - config
    volumes_from:
      - config:ro
```

## Verifying the Artifact

### Inspect Metadata

```bash
# View artifact metadata
docker buildx imagetools inspect willowcms-config:latest

# View manifest
docker manifest inspect willowcms-config:latest
```

### Verify SBOM

If the artifact includes an SBOM:

```bash
# Extract and view SBOM
docker run --rm willowcms-config:latest cat /artifact/sbom.spdx.json | jq .
```

## Security Considerations

1. **Signature Verification**: Sign artifacts with cosign for supply chain security
2. **Vulnerability Scanning**: Scan artifacts with docker scout or trivy
3. **Access Control**: Use registry access controls to limit who can push/pull
4. **Versioning**: Use semantic versioning and immutable tags

### Signing with Cosign

```bash
# Generate keypair
cosign generate-key-pair

# Sign the artifact
cosign sign --key cosign.key willowcms-config:latest

# Verify signature
cosign verify --key cosign.pub willowcms-config:latest
```

## Troubleshooting

### Common Issues

1. **Build Failures**: Check BuildKit is enabled and Docker daemon is running
2. **Registry Push Errors**: Verify authentication and repository permissions
3. **Large Artifact Size**: Review included files and optimize compression

### Debug Commands

```bash
# List contents of artifact
docker run --rm willowcms-config:latest find /artifact -type f

# Check artifact size
docker images willowcms-config:latest --format "table {{.Repository}}\\t{{.Tag}}\\t{{.Size}}"

# Inspect layers
docker history willowcms-config:latest --no-trunc
```

## Integration with CI/CD

The OCI artifact build should be integrated with your CI/CD pipeline to automatically build and publish artifacts on code changes.

Example GitHub Actions workflow:

```yaml
name: Build OCI Artifact
on:
  push:
    branches: [main]
    tags: ['v*']

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    - name: Build OCI Artifact
      run: ./tools/oci/build-oci.sh
    - name: Push to Registry
      run: |
        echo ${{ secrets.REGISTRY_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
        docker push ghcr.io/robjects-community/willowcms-config:latest
```

## References

- [OCI Artifact Specification](https://github.com/opencontainers/artifacts)
- [Docker Buildx Documentation](https://docs.docker.com/buildx/)
- [Container Registry Documentation](https://docs.docker.com/registry/)
- [WillowCMS Documentation](https://docs.willowcms.app/)