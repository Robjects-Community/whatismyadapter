# Production Docker Compose for Digital Ocean Droplet
# Optimized for 2GB RAM droplet with resource limits

services:
  willowcms:
    build:
      context: .
      dockerfile: Dockerfile  # Using the fixed Dockerfile with PHP extensions
      args:
        - UID=${DOCKER_UID:-1001}
        - GID=${DOCKER_GID:-1001}
        - BUILD_ENV=prod
    ports:
      - "${WILLOW_HTTP_PORT:-8080}:8080"
    volumes:
      - ./app:/var/www/willowcms/
      - ./tools/docker/logs/willowcms/nginx:/var/log/nginx/
      - ./tools/docker/logs/willowcms/app:/var/www/willowcms/logs/
    environment:
      DB_HOST: mysql
      DB_DATABASE: ${MYSQL_DATABASE}
      DB_USERNAME: ${MYSQL_USER}
      DB_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      TEST_DB_HOST: mysql
      REDIS_HOST: redis
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      LOG_DEBUG_PATH: ${LOG_DEBUG_PATH:-/var/www/willowcms/logs}
      LOG_ERROR_PATH: ${LOG_ERROR_PATH:-/var/www/willowcms/logs}
      LOG_QUERIES_PATH: ${LOG_QUERIES_PATH:-/var/www/willowcms/logs}
      LOG_ADMIN_ACTIONS_PATH: ${LOG_ADMIN_ACTIONS_PATH:-/var/www/willowcms/logs}
      LOG_DEBUG_FILE: ${LOG_DEBUG_FILE:-debug}
      LOG_ERROR_FILE: ${LOG_ERROR_FILE:-error}
      LOG_QUERIES_FILE: ${LOG_QUERIES_FILE:-queries}
      LOG_ADMIN_ACTIONS_FILE: ${LOG_ADMIN_ACTIONS_FILE:-bulk_actions}
      LOG_DEBUG_LEVELS: ${LOG_DEBUG_LEVELS:-notice,info,debug}
      LOG_ERROR_LEVELS: ${LOG_ERROR_LEVELS:-warning,error,critical,alert,emergency}
    depends_on:
      redis:
        condition: service_healthy
      mysql:
        condition: service_started
    deploy:
      resources:
        limits:
          memory: 768M
        reservations:
          memory: 384M
    restart: unless-stopped
    env_file:
      - ./.env

  redis:
    image: redis:${REDIS_TAG:-7.2-alpine}
    environment:
      TZ: ${APP_DEFAULT_TIMEZONE:-America/Chicago}
    command: >
      redis-server
      --requirepass "${REDIS_PASSWORD}"
      --appendonly yes
      --save "900 1 300 10 60 10000"
      --maxmemory 96m
      --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD-SHELL", "redis-cli -a \"$REDIS_PASSWORD\" ping | grep PONG"]
      interval: ${REDIS_HEALTHCHECK_INTERVAL:-10s}
      timeout: ${REDIS_HEALTHCHECK_TIMEOUT:-3s}
      retries: ${REDIS_HEALTHCHECK_RETRIES:-5}
    volumes:
      - ${REDIS_DATA_VOLUME:-redis-data:/data}
    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 64M
    restart: unless-stopped
    env_file:
      - ./.env

  mysql:
    image: mysql:${MYSQL_IMAGE_TAG:-8.0}
    ports:
      - "${MYSQL_PORT:-3310}:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./tools/docker/mysql/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      # Optimized for 2GB RAM environment
      MYSQL_INNODB_LOG_FILE_SIZE: ${MYSQL_INNODB_LOG_FILE_SIZE:-64M}
      MYSQL_INNODB_BUFFER_POOL_SIZE: ${MYSQL_INNODB_BUFFER_POOL_SIZE:-384M}
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
    restart: unless-stopped
    env_file:
      - ./.env
    command: >
      --default-authentication-plugin=mysql_native_password
      --log-error=/var/log/mysql/error.log
      --slow-query-log=1
      --slow-query-log-file=/var/log/mysql/slow.log
      --general-log=0
      --max_connections=50
      --key_buffer_size=32M
      --query_cache_size=64M
      --tmp_table_size=32M
      --max_heap_table_size=32M

  # Optional: PHPMyAdmin (disable in production for security)
  phpmyadmin:
    image: phpmyadmin:${PHPMYADMIN_IMAGE_TAG:-latest}
    depends_on:
      - mysql
    ports:
      - "${PMA_HTTP_PORT:-8082}:80"
    environment:
      - PMA_HOST=mysql
      - PMA_USER=${PMA_USER:-root}
      - PMA_PASSWORD=${PMA_PASSWORD}
      - UPLOAD_LIMIT=${UPLOAD_LIMIT:-300M}
    deploy:
      resources:
        limits:
          memory: 128M
    restart: unless-stopped
    env_file:
      - ./.env
    profiles:
      - debug  # Only start when explicitly requested: docker-compose --profile debug up

  # Optional: Email testing (disable in production)
  mailpit:
    image: axllent/mailpit:${MAILPIT_IMAGE_TAG:-latest}
    ports:
      - "${MAILPIT_SMTP_PORT:-1125}:1025"
      - "${MAILPIT_HTTP_PORT:-8025}:8025"
    volumes:
      - ./tools/docker/mailpit/data:/data
      - ./tools/docker/logs/mailpit:/var/log/mailpit
    environment:
      - MP_MAX_MESSAGES=${MP_MAX_MESSAGES:-1000}
      - MP_DATABASE=${MP_DATABASE:-/data/mailpit.db}
      - MP_SMTP_AUTH_ACCEPT_ANY=${MP_SMTP_AUTH_ACCEPT_ANY:-1}
      - MP_SMTP_AUTH_ALLOW_INSECURE=${MP_SMTP_AUTH_ALLOW_INSECURE:-1}
    deploy:
      resources:
        limits:
          memory: 64M
    restart: unless-stopped
    profiles:
      - debug

  # Optional: Redis Commander (disable in production)
  redis-commander:
    image: rediscommander/redis-commander:${REDIS_COMMANDER_IMAGE_TAG:-latest}
    depends_on:
      redis:
        condition: service_healthy
    ports:
      - "${REDIS_COMMANDER_HTTP_PORT:-8084}:8081"
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - HTTP_USER=${REDIS_COMMANDER_USERNAME:-admin}
      - HTTP_PASSWORD=${REDIS_COMMANDER_PASSWORD}
    deploy:
      resources:
        limits:
          memory: 64M
    restart: unless-stopped
    profiles:
      - debug

volumes:
  mysql_data:
    driver: local
  redis-data:
    driver: local

# Production deployment commands:
# Basic services only: docker compose -f docker-compose.prod.yml up -d
# With debug tools: docker compose -f docker-compose.prod.yml --profile debug up -d
