services:
  willowcms:
    build:
      context: .
      dockerfile: infrastructure/docker/dhi_cms/Dockerfile
      args:
        - UID=${DOCKER_UID:-1000}
        - GID=${DOCKER_GID:-1000}
    ports:
      - ${WILLOW_HTTP_PORT:-8080}:80
    volumes:
      - ./app:/var/www/html/
      - ./infrastructure/docker/willowcms/config/app/cms_app_local.php:/var/www/html/config/app_local.php
      - ./infrastructure/docker/logs/willowcms/nginx:/var/log/nginx/
      - ./infrastructure/docker/logs/willowcms/app:/var/www/html/logs/
    environment:
      DB_HOST: mysql
      DB_DATABASE: ${MYSQL_DATABASE}
      DB_USERNAME: ${MYSQL_USER}
      DB_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      TEST_DB_HOST: mysql
      REDIS_HOST: redis
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      LOG_DEBUG_PATH: ${LOG_DEBUG_PATH:-/var/www/html/logs}
      LOG_ERROR_PATH: ${LOG_ERROR_PATH:-/var/www/html/logs}
      LOG_QUERIES_PATH: ${LOG_QUERIES_PATH:-/var/www/html/logs}
      LOG_ADMIN_ACTIONS_PATH: ${LOG_ADMIN_ACTIONS_PATH:-/var/www/html/logs}
      LOG_DEBUG_FILE: ${LOG_DEBUG_FILE:-debug}
      LOG_ERROR_FILE: ${LOG_ERROR_FILE:-error}
      LOG_QUERIES_FILE: ${LOG_QUERIES_FILE:-queries}
      LOG_ADMIN_ACTIONS_FILE: ${LOG_ADMIN_ACTIONS_FILE:-bulk_actions}
      LOG_DEBUG_LEVELS: ${LOG_DEBUG_LEVELS:-notice,info,debug}
      LOG_ERROR_LEVELS: ${LOG_ERROR_LEVELS:-warning,error,critical,alert,emergency}
    depends_on:
      redis:
        condition: service_healthy
      mysql:
        condition: service_started
    env_file:
      - ./.env

  redis:
    build:
      context: .
      dockerfile: docker/redis/Dockerfile
      args:
        REDIS_TAG: ${REDIS_TAG:-7.2-alpine}
    image: willow-redis:${REDIS_TAG:-7.2-alpine}
    environment:
      TZ: ${APP_DEFAULT_TIMEZONE:-America/Chicago}
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      REDIS_APPENDONLY: ${REDIS_APPENDONLY:-yes}
      REDIS_SAVE: ${REDIS_SAVE:-"900 1 300 10 60 10000"}
      REDIS_DATA_DIR: /data
    healthcheck:
      test: ["CMD-SHELL", "redis-cli -a \"$REDIS_PASSWORD\" ping | grep PONG"]
      interval: ${REDIS_HEALTHCHECK_INTERVAL:-10s}
      timeout: ${REDIS_HEALTHCHECK_TIMEOUT:-3s}
      retries: ${REDIS_HEALTHCHECK_RETRIES:-5}
    volumes:
      - ${REDIS_DATA_VOLUME:-redis-data:/data}
    restart: on-failure:5
    command: >
      redis-server
      --bind 0.0.0.0
      --port 6379
      --dir /data
      --requirepass ${REDIS_PASSWORD:-}
      --appendonly yes
      --appendfsync everysec
      --save 900 1
      --save 300 10
      --save 60 10000
      --maxmemory-policy allkeys-lru
      --tcp-keepalive 300
      --loglevel notice
    env_file:
      - ./.env

  mysql:
    image: mysql:${MYSQL_IMAGE_TAG:-8.0}
    ports:
      - ${MYSQL_PORT:-3310}:3306
    volumes:
      - mysql_data:/var/lib/mysql
      - ./infrastructure/docker/mysql/init.sql:/docker-entrypoint-initdb.d/init.sql
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_INNODB_LOG_FILE_SIZE: ${MYSQL_INNODB_LOG_FILE_SIZE:-256M}
      MYSQL_INNODB_BUFFER_POOL_SIZE: ${MYSQL_INNODB_BUFFER_POOL_SIZE:-256M}
    env_file:
      - ./.env
    command: '--default-authentication-plugin=mysql_native_password --log-error=/var/log/mysql/error.log --slow-query-log=1 --slow-query-log-file=/var/log/mysql/slow.log --general-log=1 --general-log-file=/var/log/mysql/query.log'

  phpmyadmin:
    image: phpmyadmin:${PHPMYADMIN_IMAGE_TAG:-latest}
    depends_on:
      - mysql
    ports:
      - ${PMA_HTTP_PORT:-8082}:80
    environment:
      - PMA_HOST=mysql
      - PMA_USER=${PMA_USER:-root}
      - PMA_PASSWORD=${PMA_PASSWORD:-password}
      - UPLOAD_LIMIT=${UPLOAD_LIMIT:-300M}
    env_file:
      - ./.env

  mailpit:
    image: axllent/mailpit:${MAILPIT_IMAGE_TAG:-latest}
    ports:
      - ${MAILPIT_SMTP_PORT:-1125}:1025
      - ${MAILPIT_HTTP_PORT:-8025}:8025
    volumes:
      - ./infrastructure/docker/mailpit/data:/data
      - ./infrastructure/docker/logs/mailpit:/var/log/mailpit
    environment:
      - MP_MAX_MESSAGES=${MP_MAX_MESSAGES:-5000}
      - MP_DATABASE=${MP_DATABASE:-/data/mailpit.db}
      - MP_SMTP_AUTH_ACCEPT_ANY=${MP_SMTP_AUTH_ACCEPT_ANY:-1}
      - MP_SMTP_AUTH_ALLOW_INSECURE=${MP_SMTP_AUTH_ALLOW_INSECURE:-1}

  redis-commander:
    image: rediscommander/redis-commander:${REDIS_COMMANDER_IMAGE_TAG:-latest}
    depends_on:
      redis:
        condition: service_healthy
    ports:
      - ${REDIS_COMMANDER_HTTP_PORT:-8084}:8081
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - HTTP_USER=${REDIS_COMMANDER_USERNAME:-root}
      - HTTP_PASSWORD=${REDIS_COMMANDER_PASSWORD:-root}

volumes:
  mysql_data: null
  redis-data: null
  rabbitmq_data: null
  mailpit_data: null
